5장에서는 지금까지 만든 DAO에 트랜잭션을 적용해보면서 스프링이 어떻게 성격이 비슷한 여러 종류의 기술을 추상화하고 이를 일관된 방법으로 사용할 수 있도록 지원하는지를 살펴볼 것이다.


# 5.1 사용자 레벨 관리 기능 추가

지금까지 만들었던 `UserDao`에 사용자의 활동내역을 참고해서 레벨을 조정해주는 기능을 넣어보자.

사용자 관리 기능에서 구현해야 할 비즈니스 로직은 다음과 같다.

- 사용자의 레벨은 BASIC, SILVER, GOLD 세 가지 중 하나다.
- 사용자가 처음 가입하면 BASIC 레벨이 되며, 이후 활동에 따라서 한 단계씩 업그레이드될 수 있다.
- 가입 후 50회 이상 로그인을 하면 BASIC에서 SILVER 레벨이 된다.
- SILVER 레벨이면서 30번 이상 추천을 받으면 GOLD 레벨이 된다.
- 사용자 레벨의 변경 작업은 일정한 주기를 가지고 일괄적으로 진행된다. 변경 작업 전에는 조건을 충족하더라도 레벨의 변경이 일어나지 않는다.


## 5.1.1 필드 추가

### Level enum
`User` 클래스에 사용자의 레벨을 저장할 필드를 추가하자.

- DB 에는 각 레벨을 코드화해서 숫자로 넣는다. DB 용량도 많이 차지하지 않고 가볍다.
- 자바의 `User`에는 숫자 타입을 직접 사용하는 것보다 enum을 이용하는 것이 안전하고 편리하다.
  - 숫자로 상수로 정의해 놓고 사용하면, 다른 종류의 정보를 넣는 실수를 해도 컴파일러가 체크해주지 못한다.

`Level` enum은 내부에는 DB에 저장할 int 타입의 값을 갖고 있지만, 겉으로는 `Level` 타입의 오브젝트이기 때문에 안전하게 사용할 수 있다.  

### User 필드 추가
`Level` 타입의 변수를 `User` 클래스, user DB에 추가하자.



### UserDaoTest 테스트 수정
`UserDaoJdbc`와 테스트에도 필드를 추가해야 한다. 테스트까지 갖추고 있는 안정된 코드이기 때문에, 기존 코드에 새로운 기능을 추가하려면 테스트를 먼저 만드는 것이 안전하다.


### JdbcDaoJdbc 수정
미리 준비된 테스트가 성공하도록 `UserDaoJdbc` 클래스를 수정한다.  




## 5.1.2 사용자 수정 기능 추가
수정할 정보가 담긴 `User` 오브젝트를 전달하면 id를 참고해서 사용자를 찾아 필드 정보를 UPDATE 문을 이용해 모두 변경해주는 메소드를 하나 만들자.

### 수정 기능 테스트 추가

픽스쳐 오브젝트를 하나 등록하고, id를 제외한 필드의 내용을 바꾼 뒤 `update()`를 호출한다.  
이제 다시 id로 조회해서 가져온 `User` 오브젝트와 수정한 픽스처 오브젝트를 비교하여 해당 id의 사용자 정보가 변경됐음을 확인하자.  

### UserDao와 UserDaoJdbc 수정
`UserDao` 인터페이스에 `update()` 메소드를 추가한다.


### 수정 테스트 보완
JDBC 개발에서 리소스 반환과 같은 기본 작업을 제외하면 가장 많은 실수가 일어나는 곳은 SQL 문장이다.

테스트로는 검증하지 못하는 오류가 있을 수 있는데, UPDATE 문장에서 WHERE 절을 빼먹는 경우이다.
update() 테스트에서 바뀐 로우의 내용만 확인해보면 정상적으로 동작한 것으로 보이지만,  
수정하지 않아야 할 로우의 내용이 그대로 남아 있는지 확인이 필요하다.

이 문제를 해결하려면 다음과 같은 방법이 있을 수 있다.

1. `JdbcTemplate`의 `update()`가 돌려주는 리턴 값을 확인한다.   
`JdbcTemplate`의 `update()`는 UPDATE나 DELETE 같이 테이블의 내용에 영향을 주는 SQL을 실행하면 영향받은 로우의 개수를 돌려주는데, `update()` 테스트라면 이 값이 1인지 확인하는 코드를 하나 더 추가해주면 된다.

2. 테스트를 보강해서 원하는 사용자 외의 정보는 변경되지 않았음을 직접 확인한다.  
사용자를 두 명 등록해놓고, 그중 하나만 수정한 뒤에 수정된 사용자와 수정하지 않은 사용자의 정보를 모두 확인하면 된다.

두번째를 적용하여, `update()` 메소드의 SQL에서 WHERE를 제외하고 테스트가 실패하는지도 함께 확인해보자. 




## 5.1.3 UserService.upgradeLevels()



## 5.1.4 UserService.add()
























## 5.1.5 코드 개선
