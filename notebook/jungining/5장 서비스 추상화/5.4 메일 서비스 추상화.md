# 5.4 메일 서비스 추상화

고객으로부터 레벨이 올라가는 사용자에게는 안내 메일을 발송해달라는 요청이 있다. 먼저, 사용자의 이메일 정보를 관리해야 한다. 그리고 업그레이드 작업을 담은 `upgradeLevel()` 메소드에 메일 발송 기능을 추가하면 된다.


## 5.4.1 JavaMail을 이용한 메일 발송 기능
DB에 email 필드 추각, User클래스에 email 프로퍼티 추가, UserDao에 userMappper에 email필드 처리 코드를 추가해주고 테스트코드도 수정한다.

### JavaMail 메일 발송
자바에서 메일을 발송할 때는 표준 메일 기술인 JavaMail을 사용한다. java.mail패키지에서 제공하는 자바의 이메일 클래스를 사용한다. upgradeLevel안에 메일 발송 메소드를 호출한다. 

### JavaMail이 포함된 코드의 테스트
SMTP메일 서버가 준비되어 있지 않다면 테스트는 실패한다.

테스트를 하면서 매번 메일이 발송되는 것은 부하가 큰 작업이므로 부적절하다. JavaMail을 통해 메일 서버까지만 메일이 잘 전달됐으면, 사용자에게도 메일이 잘 전달된다고 생각할 수 있다. 따라서 JavaMail API를 통해 요청이 들어갔다는 보장만 된다면 굳이 테스트때마다 JavaMail을 구동시킬 필요가 없다. 

## 5.4.3 테스트를 위한 서비스 추상화

실제 메일 전송을 수행하는 JavaMail 대신에 테스트에서 사용할 오브젝트를 만들어서 사용하면 문제는 모두 해결된다. JavaMail은 구현을 테스트용으로 바꿔치기 힘든 클래스다. 서비스 추상화를 하면 문제를 해결할 수 있다.

### 메일 발송 기능 추상화

MailSender라는 JavaMail의 서비스 추상화 인터페이스를 만든다. sendUpgradeMail()에서는 MailMessage 타입의 SimpleMailMessage 오브젝트를 만들어서 메시지를 넣은 뒤에 JavaMailSender타입 오브젝트의 send()메소드에 전달해주면 된다.

스프링의 DI도 적용해보자.

### 테스트와 서비스 추상화

> 서비스 추상화 : 일반적으로 기능은 유사하나 사용 방법이 다른 로우레벨의 다양한 기술에 대해 일관성 있는 접근 방법을 제공하는 것을 의미한다.

JavaMail과 같이 테스트를 어렵게 만드는 API를 사용할 때도 유용하게 사용된다. JavaMail이 아닌 다른 메세징 서버의 API를 이용하는 경우에도 MailSender 구현 클래스를 만들어서 DI 해주면 된다. 

비즈니스 로직이 바뀌지 않는 한 UserService는 수정할 필요가 없다.

> 문제점 : 트랜잭션 개념이 빠져있다.

레벨 업그레이드에 트랜잭션이 적용되어 있으므로 메일 발송 기능에도 트랜잭션을 적용해야 한다.

- 발송 대상을 별도의 목록에 저장 : 사용자 관리 비즈니스 로직과 메일 발송 트랜잭션 기술 부분이 섞인다.
- MailSender를 확장해서 메일 전송에 트랜잭션 개념을 적용 : 서로 다른 종류의 작업을 분리해 처리가 가능하다.